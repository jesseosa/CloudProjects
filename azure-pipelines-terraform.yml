trigger:
  branches: [ main ]
pr:
  branches: [ main ]

# ====== EDIT THESE NAMES IN ONE PLACE ======
variables:
  projectName: 'qashqade-demo'     # used to derive resource names
  location: 'eastus'
  terraformVersion: '1.6.6'
  azureSubscription: 'Qashqade-Azure-Connection'  # Service connection name

  # Backend config (must meet Azure naming rules)
  rgName: '$(projectName)-rg'
  saNameRaw: '$(projectName)tfstate'      # 3–24 chars, lowercase letters/numbers only, no hyphens
  containerName: 'tfstate'
  stateKey: 'terraform.tfstate'
# ==========================================

pool:
  vmImage: 'ubuntu-latest'

stages:
# 1) Bootstrap backend (RG + Storage + container) and run terraform plan
- stage: Plan
  displayName: 'Terraform: Bootstrap + Plan'
  jobs:
  - job: plan
    displayName: 'Bootstrap remote state + terraform plan'
    steps:
    - checkout: self
      fetchDepth: 1

    # Ensure terraform is available (Linux amd64)
    - script: |
        set -e
        curl -sSL -o tf.zip https://releases.hashicorp.com/terraform/$(terraformVersion)/terraform_$(terraformVersion)_linux_amd64.zip
        unzip -o tf.zip
        sudo mv terraform /usr/local/bin/terraform
        terraform -version
      displayName: 'Install Terraform $(terraformVersion)'

    # Normalize SA name (lowercase, strip hyphens) and create RG/SA/container idempotently
    - task: AzureCLI@2
      displayName: 'Bootstrap remote state resources'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -euo pipefail

          RG_NAME="$(rgName)"
          LOCATION="$(location)"
          # normalize: lowercase and remove hyphens
          SA_NAME="$(echo '$(saNameRaw)' | tr '[:upper:]' '[:lower:]' | tr -d '-')"
          CONTAINER_NAME="$(containerName)"

          echo "RG_NAME=$RG_NAME"
          echo "SA_NAME=$SA_NAME"
          echo "CONTAINER_NAME=$CONTAINER_NAME"

          az group create -n "$RG_NAME" -l "$LOCATION" 1>/dev/null

          if ! az storage account show -n "$SA_NAME" -g "$RG_NAME" 1>/dev/null 2>&1; then
            az storage account create -n "$SA_NAME" -g "$RG_NAME" -l "$LOCATION" \
              --sku Standard_LRS --kind StorageV2 --allow-blob-public-access false --https-only true 1>/dev/null
          fi

          SA_KEY=$(az storage account keys list -n "$SA_NAME" -g "$RG_NAME" --query '[0].value' -o tsv)
          az storage container create --name "$CONTAINER_NAME" --account-name "$SA_NAME" --account-key "$SA_KEY" 1>/dev/null

          echo "##vso[task.setvariable variable=BACKEND_RG]$RG_NAME"
          echo "##vso[task.setvariable variable=BACKEND_SA]$SA_NAME"
          echo "##vso[task.setvariable variable=BACKEND_CONTAINER]$CONTAINER_NAME"

    # Terraform fmt + validate + plan (using remote backend)
    - script: |
        set -euo pipefail
        cd terraform

        echo "Using backend:"
        echo "  RG=$(BACKEND_RG)"
        echo "  SA=$(BACKEND_SA)"
        echo "  CN=$(BACKEND_CONTAINER)"
        echo "  KEY=$(stateKey)"

        terraform init \
          -backend-config="resource_group_name=$(BACKEND_RG)" \
          -backend-config="storage_account_name=$(BACKEND_SA)" \
          -backend-config="container_name=$(BACKEND_CONTAINER)" \
          -backend-config="key=$(stateKey)"

        terraform fmt -check
        terraform validate

        terraform plan -out=tfplan
        terraform show -no-color tfplan > tfplan.txt
      displayName: 'terraform init / fmt / validate / plan'

    # Publish plan artifact for review
    - task: PublishBuildArtifacts@1
      displayName: 'Publish plan artifact'
      inputs:
        PathtoPublish: 'terraform/tfplan.txt'
        ArtifactName: 'tfplan'
        publishLocation: 'Container'

# 2) Manual approval gate, then apply
- stage: Apply
  displayName: 'Terraform: Apply'
  dependsOn: Plan
  condition: succeeded()
  jobs:
  - job: approve
    displayName: 'Manual approval'
    steps:
    - task: ManualValidation@0
      inputs:
        notifyUsers: ''          # optionally put reviewer emails here
        instructions: |
          Review the tfplan artifact (Artifacts tab → tfplan/tfplan.txt).
          Approve to apply Terraform changes to Azure (RG/Storage/ACR, per your code).
        onTimeout: 'reject'
        timeout: '2d'

  - job: apply
    displayName: 'terraform apply'
    dependsOn: approve
    condition: succeeded()
    steps:
    - checkout: self
      fetchDepth: 1

    - script: |
        set -e
        curl -sSL -o tf.zip https://releases.hashicorp.com/terraform/$(terraformVersion)/terraform_$(terraformVersion)_linux_amd64.zip
        unzip -o tf.zip
        sudo mv terraform /usr/local/bin/terraform
        terraform -version
      displayName: 'Install Terraform $(terraformVersion)'

    - task: AzureCLI@2
      displayName: 'terraform apply (remote state)'
      inputs:
        azureSubscription: $(azureSubscription)
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -euo pipefail
          cd terraform

          # Re-init (safe) against the same backend
          terraform init \
            -backend-config="resource_group_name=$(rgName)" \
            -backend-config="storage_account_name=$(echo '$(saNameRaw)' | tr '[:upper:]' '[:lower:]' | tr -d '-')" \
            -backend-config="container_name=$(containerName)" \
            -backend-config="key=$(stateKey)"

          terraform plan -out=tfplan   # re-plan to be safe
          terraform apply -auto-approve tfplan

          # Print key outputs (if defined in outputs.tf)
          echo "---- Outputs ----"
          terraform output

